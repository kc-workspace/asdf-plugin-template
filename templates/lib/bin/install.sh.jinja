#!/usr/bin/env bash

__asdf_bin() {
  local type="${ASDF_INSTALL_TYPE:?}"
  local version="${ASDF_INSTALL_VERSION:?}"
  local indir="${ASDF_DOWNLOAD_PATH:?}"
  local outdir="${ASDF_INSTALL_PATH:?}"
  local concurrency="${ASDF_CONCURRENCY:?}"

  local inpath outpath

  kc_asdf_step_start "install" "'%s' at %s" \
    "$KC_ASDF_APP_NAME" "$outdir"
  kc_asdf_debug "using install '%s' type" \
    "{{ install_type }}"

  if [[ "$type" == "ref" ]] &&
    command -v _kc_asdf_install_source >/dev/null; then
    if ! command -v _kc_asdf_download_source >/dev/null; then
      kc_asdf_throw 4 "install source failed because no download logic define"
    fi
    kc_asdf_debug "installing using 'ref' mode"
    if ! _kc_asdf_install_source \
      "$version" \
      "$indir" "$outdir" \
      "$concurrency"; then
      kc_asdf_throw 3 "install source failed"
    fi
  elif [[ "$type" == "version" ]]; then
    local download_type install_type="{{ install_type }}"
    download_type="$(kc_asdf_get_download_type)"

    kc_asdf_debug "installing using 'version' mode"
    if [[ "$download_type" == "archive-file" ]] &&
      [[ "$install_type" == "single-file" ]]; then
      outdir="$outdir/bin"
      kc_asdf_debug "creating bin directory at %s" "$outdir"
      mkdir -p "$outdir" 2>/dev/null

      local filename="$KC_ASDF_APP_NAME"
      inpath="$indir/${KC_ASDF_DOWNLOAD_LOC:?}"
      outpath="$outdir/$filename"
    elif [[ "$download_type" == "archive-file" ]] &&
      [[ "$install_type" == "single-file" ]]; then
      inpath="$indir"
      outpath="$(dirname "$outdir")"
    else
      outdir="$outdir/bin"
      kc_asdf_debug "creating bin directory at %s" "$outdir"
      mkdir -p "$outdir" 2>/dev/null

      local filename="$KC_ASDF_APP_NAME"
      inpath="$indir/$filename"
      outpath="$outdir/$filename"
    fi

    kc_asdf_debug "copying input (%s) to output (%s)" \
      "$inpath" "$outpath"
    if ! cp "$inpath" "$outpath"; then
      kc_asdf_throw 9 "cannot move directory from %s to %s" \
        "$inpath" "$outpath"
    fi

    ## Chmod all bin files
    outdir="${ASDF_INSTALL_PATH:?}"
    for file in "$outdir"/bin/*; do
      kc_asdf_debug "exec: chmod +x $file"
      chmod +x "$file"
    done
  else
    kc_asdf_throw 4 "install type (%s) not support" "$type"
  fi

  # shellcheck disable=SC2011
  kc_asdf_debug "install directory: [%s]" \
    "$(ls "$outdir" | xargs echo)"
  # shellcheck disable=SC2011
  kc_asdf_debug "bin directory: [%s]" \
    "$(ls "$outdir/bin" | xargs echo)"
  kc_asdf_step_success "install" "successfully"
}
